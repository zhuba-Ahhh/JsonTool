<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>JSON to CSV 转换器</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/antd/5.21.5/reset.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.7/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/antd/5.21.5/antd.min.js"></script>
    <style>
      body {
        background-color: #f0f2f5;
        padding: 20px;
      }
      .json-converter {
        max-width: 1000px;
        margin: auto;
        background: #fff;
        padding: 24px;
        border-radius: 8px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }
      .json-viewer {
        border: 1px solid #d9d9d9;
        border-radius: 2px;
        padding: 16px;
        margin-top: 16px;
      }
      .mapping-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 16px;
        margin-top: 16px;
      }
      .mapping-item {
        display: flex;
        align-items: center;
        gap: 8px;
      }
    </style>
  </head>
  <body>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-json-view@1.21.3/dist/main.min.js"></script>

    <script type="text/babel">
      const { useState, useEffect, useCallback } = React;
      const { default: JSONView } = reactJsonView;
      const { Button, Input, Checkbox, Space, Typography, message, Collapse } = antd;
      const { TextArea } = Input;
      const { Title } = Typography;
      const { Panel } = Collapse;

      const KeyMappingForm = ({ keys, onMappingChange }) => {
        const [mappings, setMappings] = useState(
          keys.reduce((acc, key) => ({ ...acc, [key]: key }), {})
        );
        const [selectedKeys, setSelectedKeys] = useState(
          keys.reduce((acc, key) => ({ ...acc, [key]: true }), {})
        );

        useEffect(() => {
          onMappingChange({ mappings, selectedKeys });
        }, [mappings, selectedKeys]);

        const handleInputChange = (key, value) => {
          setMappings(prev => ({ ...prev, [key]: value }));
        };

        const handleCheckboxChange = (key) => {
          setSelectedKeys(prev => ({ ...prev, [key]: !prev[key] }));
        };

        const handleRemoveKey = (keyToRemove) => {
          setSelectedKeys(prev => {
            const { [keyToRemove]: _, ...rest } = prev;
            return rest;
          });
          setMappings(prev => {
            const { [keyToRemove]: _, ...rest } = prev;
            return rest;
          });
        };

        return (
          <Collapse defaultActiveKey={['1']}>
            <Panel header="表头映射" key="1">
              <div className="mapping-grid">
                {Object.keys(selectedKeys).map((key) => (
                  <div key={key} className="mapping-item">
                    <Checkbox
                      checked={selectedKeys[key]}
                      onChange={() => handleCheckboxChange(key)}
                    />
                    <Input
                      value={mappings[key] || key}
                      onChange={(e) => handleInputChange(key, e.target.value)}
                      disabled={!selectedKeys[key]}
                      style={{ width: '60%' }}
                    />
                    <Button danger onClick={() => handleRemoveKey(key)}>删除</Button>
                  </div>
                ))}
              </div>
            </Panel>
          </Collapse>
        );
      };

      const App = () => {
        const [jsonData, setJsonData] = useState(
          localStorage.getItem("jsonData") || "{}"
        );
        const [parsedData, setParsedData] = useState(null);
        const [keyMappings, setKeyMappings] = useState({});

        const viewJsonData = useCallback(() => {
          try {
            const data = JSON.parse(jsonData);
            localStorage.setItem("jsonData", jsonData);
            setParsedData(data);
            message.success("解析成功");
            ReactDOM.render(
              <JSONView src={data} />,
              document.getElementById("jsonViewer")
            );
          } catch (error) {
            message.error("输入的JSON数据格式有误，请检查后重试！");
          }
        }, [jsonData]);

        useEffect(() => {
          viewJsonData();
        }, []);

        const clearJsonData = useCallback(() => {
          setJsonData("{}");
          setParsedData(null);
          localStorage.setItem("jsonData", "{}");
          ReactDOM.render(
            <JSONView src={{}} />,
            document.getElementById("jsonViewer")
          );
        }, []);

        const exportToJson = useCallback(() => {
          try {
            let data = parsedData || JSON.parse(jsonData);
            localStorage.setItem("jsonData", jsonData);

            data = Array.isArray(data) ? data : [data];

            const selectedHeaders = Object.keys(keyMappings.selectedKeys)
              .filter((key) => keyMappings.selectedKeys[key]);

            const csvContent = [
              selectedHeaders
                .map((header) => `"${keyMappings.mappings[header] || header}"`)
                .join(","),
              ...data.map((row) =>
                selectedHeaders
                  .map((header) => {
                    let value = row[header] || "";
                    value = Array.isArray(value) ? value.join("\n") : String(value);
                    return `"${value.replace(/"/g, '""')}"`;
                  })
                  .join(",")
              ),
            ].join("\n");

            const blob = new Blob(["\uFEFF" + csvContent], {
              type: "text/csv;charset=utf-8;",
            });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `json数据表_${new Date().toISOString().replace(/[-:]/g, "").slice(0, 14)}.csv`;
            link.click();
          } catch (error) {
            message.error("导出失败，请检查数据格式！");
            console.error(error);
          }
        }, [jsonData, parsedData, keyMappings]);

        return (
          <div className="json-converter">
            <Title level={2}>JSON to CSV 转换器</Title>
            <Space className="action-buttons" style={{ marginBottom: 16 }}>
              <Button type="primary" onClick={viewJsonData}>解析</Button>
              <Button onClick={exportToJson}>导出</Button>
              <Button danger onClick={clearJsonData}>清空</Button>
            </Space>
            <TextArea
              value={jsonData}
              onChange={(e) => setJsonData(e.target.value)}
              placeholder="请输入或粘贴JSON数据..."
              rows={10}
              style={{ marginBottom: 16 }}
            />
            {parsedData && Object.keys(parsedData).length > 0 && (
              <KeyMappingForm
                keys={Object.keys(Array.isArray(parsedData) ? parsedData[0] : parsedData)}
                onMappingChange={setKeyMappings}
              />
            )}
            <div id="jsonViewer" className="json-viewer"></div>
          </div>
        );
      };

      ReactDOM.createRoot(document.getElementById("app")).render(<App />);
    </script>
    <div id="app"></div>
  </body>
</html>
