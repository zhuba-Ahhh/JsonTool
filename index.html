<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>JSON to CSV 转换器</title>
    <link rel="icon" type="image/svg+xml" href="./icon.svg" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/antd/5.21.5/reset.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.7/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/antd/5.21.5/antd.min.js"></script>
    <style>
      body {
        background-color: #f0f2f5;
        padding: 20px;
      }

      .json-converter {
        max-width: 1000px;
        margin: auto;
        background: #fff;
        padding: 24px;
        border-radius: 8px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }

      .json-viewer {
        border: 1px solid #d9d9d9;
        border-radius: 2px;
        padding: 16px;
        margin-top: 16px;
      }

      .mapping-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 16px;
        margin-top: 16px;
      }

      .mapping-item {
        display: flex;
        align-items: center;
        gap: 8px;
      }
    </style>
  </head>

  <body>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-json-view@1.21.3/dist/main.min.js"></script>

    <script type="text/babel">
      const { useState, useEffect, useCallback, useMemo } = React;
      const { default: JSONView } = reactJsonView;
      const { Button, Input, Checkbox, Space, Typography, message, Collapse } =
        antd;
      const { TextArea, Search = () => null } = Input;
      const { Title } = Typography;
      const { Panel } = Collapse;

      const KeyMappingForm = ({ keys, onMappingChange }) => {
        const [state, setState] = useState({
          mappings: keys.reduce((acc, key) => ({ ...acc, [key]: key }), {}),
          selectedKeys: keys.reduce(
            (acc, key) => ({ ...acc, [key]: true }),
            {}
          ),
          sortOrder: "asc",
          searchTerm: "",
        });

        useEffect(() => {
          onMappingChange({
            mappings: state.mappings,
            selectedKeys: state.selectedKeys,
          });
        }, [state.mappings, state.selectedKeys]);

        // 使用 useCallback 优化性能
        const updateState = useCallback((updates) => {
          setState((prev) => ({ ...prev, ...updates }));
        }, []);

        // 使用 useMemo 优化过滤和排序逻辑
        const filteredAndSortedKeys = useMemo(() => {
          return Object.keys(state.selectedKeys)
            .filter((key) =>
              key.toLowerCase().includes(state.searchTerm.toLowerCase())
            )
            .sort((a, b) =>
              state.sortOrder === "asc"
                ? a.localeCompare(b)
                : b.localeCompare(a)
            );
        }, [state.selectedKeys, state.searchTerm, state.sortOrder]);

        const handleInputChange = (key, value) => {
          updateState({ mappings: { ...state.mappings, [key]: value } });
        };

        const handleCheckboxChange = (key) => {
          updateState({
            selectedKeys: {
              ...state.selectedKeys,
              [key]: !state.selectedKeys[key],
            },
          });
        };

        const handleRemoveKey = (keyToRemove) => {
          const { [keyToRemove]: _, ...restSelectedKeys } = state.selectedKeys;
          const { [keyToRemove]: __, ...restMappings } = state.mappings;
          updateState({
            selectedKeys: restSelectedKeys,
            mappings: restMappings,
          });
        };

        const toggleAllSelection = () => {
          const allSelected = Object.values(state.selectedKeys).every((v) => v);
          updateState({
            selectedKeys: Object.keys(state.selectedKeys).reduce(
              (acc, key) => ({ ...acc, [key]: !allSelected }),
              {}
            ),
          });
        };

        const toggleSortOrder = () => {
          const newSortOrder = state.sortOrder === "asc" ? "desc" : "asc";
          const sortedKeys = Object.keys(state.selectedKeys).sort((a, b) =>
            newSortOrder === "asc" ? a.localeCompare(b) : b.localeCompare(a)
          );
          updateState({
            sortOrder: newSortOrder,
            selectedKeys: sortedKeys.reduce(
              (acc, key) => ({ ...acc, [key]: state.selectedKeys[key] }),
              {}
            ),
            mappings: sortedKeys.reduce(
              (acc, key) => ({ ...acc, [key]: state.mappings[key] }),
              {}
            ),
          });
        };

        return (
          <Collapse defaultActiveKey={["1"]}>
            <Panel header="表头映射" key="1">
              <Space
                style={{
                  width: "100%",
                  justifyContent: "space-between",
                  marginBottom: "16px",
                }}
              >
                {Search && (
                  <Search
                    placeholder="搜索键名"
                    onSearch={(value) => updateState({ searchTerm: value })}
                    onChange={(e) =>
                      updateState({ searchTerm: e.target.value })
                    }
                    style={{ width: 200 }}
                  />
                )}
                <Space>
                  <Button onClick={toggleAllSelection}>
                    {Object.values(state.selectedKeys).every((v) => v)
                      ? "取消全选"
                      : "全选"}
                  </Button>
                  <Button onClick={toggleSortOrder}>
                    {state.sortOrder === "asc" ? "按字母降序" : "按字母升序"}
                  </Button>
                </Space>
              </Space>
              <div className="mapping-grid">
                {filteredAndSortedKeys.map((key) => (
                  <MappingItem
                    key={key}
                    itemKey={key}
                    mapping={state.mappings[key]}
                    isSelected={state.selectedKeys[key]}
                    onCheckboxChange={handleCheckboxChange}
                    onInputChange={handleInputChange}
                    onRemoveKey={handleRemoveKey}
                  />
                ))}
              </div>
            </Panel>
          </Collapse>
        );
      };

      const MappingItem = ({
        itemKey,
        mapping,
        isSelected,
        onCheckboxChange,
        onInputChange,
        onRemoveKey,
      }) => (
        <div className="mapping-item">
          <Checkbox
            checked={isSelected}
            onChange={() => onCheckboxChange(itemKey)}
          />
          <Typography.Text
            style={{
              marginRight: "8px",
              minWidth: "60px",
              whiteSpace: "nowrap",
              overflow: "hidden",
              textOverflow: "ellipsis",
            }}
          >
            {itemKey}:
          </Typography.Text>
          <Input
            value={mapping}
            onChange={(e) => onInputChange(itemKey, e.target.value)}
            disabled={!isSelected}
            style={{ width: "60%" }}
          />
          <Button danger onClick={() => onRemoveKey(itemKey)}>
            删除
          </Button>
        </div>
      );

      const App = () => {
        const [state, setState] = useState({
          jsonData: localStorage.getItem("jsonData") || "{}",
          parsedData: null,
          keyMappings: {},
        });

        const updateState = (updates) => {
          setState((prev) => ({ ...prev, ...updates }));
        };

        const handleJsonData = useCallback(
          (action) => {
            try {
              let data;
              if (action === "view") {
                data = JSON.parse(state.jsonData);
                localStorage.setItem("jsonData", state.jsonData);
                updateState({ parsedData: data });
                message.success("解析成功");
              } else if (action === "clear") {
                data = {};
                updateState({ jsonData: "{}", parsedData: null });
                localStorage.setItem("jsonData", "{}");
              }
              ReactDOM.render(
                <JSONView src={data} />,
                document.getElementById("jsonViewer")
              );
            } catch (error) {
              message.error("输入的JSON数据格式有误，请检查后重试！");
            }
          },
          [state.jsonData]
        );

        useEffect(() => {
          handleJsonData("view");
        }, []);

        const exportToJson = useCallback(() => {
          try {
            let data = state.parsedData || JSON.parse(state.jsonData);
            localStorage.setItem("jsonData", state.jsonData);

            data = Array.isArray(data) ? data : [data];

            const selectedHeaders = Object.keys(
              state.keyMappings.selectedKeys
            ).filter((key) => state.keyMappings.selectedKeys[key]);

            const csvContent = [
              selectedHeaders
                .map(
                  (header) =>
                    `"${state.keyMappings.mappings[header] || header}"`
                )
                .join(","),
              ...data.map((row) =>
                selectedHeaders
                  .map((header) => {
                    let value = row[header] || "";
                    value = Array.isArray(value)
                      ? value.join("\n")
                      : String(value);
                    return `"${value.replace(/"/g, '""')}"`;
                  })
                  .join(",")
              ),
            ].join("\n");

            const blob = new Blob(["\uFEFF" + csvContent], {
              type: "text/csv;charset=utf-8;",
            });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `json数据表_${new Date()
              .toISOString()
              .replace(/[-:]/g, "")
              .slice(0, 14)}.csv`;
            link.click();
          } catch (error) {
            message.error("导出失败，请检查数据格式！");
            console.error(error);
          }
        }, [state.jsonData, state.parsedData, state.keyMappings]);

        return (
          <div className="json-converter">
            <Title level={2}>JSON to CSV 转换器</Title>
            <Space className="action-buttons" style={{ marginBottom: 16 }}>
              <Button type="primary" onClick={() => handleJsonData("view")}>
                解析
              </Button>
              <Button onClick={exportToJson}>导出</Button>
              <Button danger onClick={() => handleJsonData("clear")}>
                清空
              </Button>
            </Space>
            <TextArea
              value={state.jsonData}
              onChange={(e) => updateState({ jsonData: e.target.value })}
              placeholder="请输入或粘贴JSON数据..."
              rows={10}
              style={{ marginBottom: 16 }}
            />
            {state.parsedData && Object.keys(state.parsedData).length > 0 && (
              <KeyMappingForm
                keys={Object.keys(
                  Array.isArray(state.parsedData)
                    ? state.parsedData[0]
                    : state.parsedData
                )}
                onMappingChange={(mappings) =>
                  updateState({ keyMappings: mappings })
                }
              />
            )}
            <div id="jsonViewer" className="json-viewer"></div>
          </div>
        );
      };

      ReactDOM.createRoot(document.getElementById("app")).render(<App />);
    </script>
    <div id="app"></div>
  </body>
</html>
